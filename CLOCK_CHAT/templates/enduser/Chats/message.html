{% extends "enduser/Chats/chat.html" %} {% block title %}Message{% endblock %}
{% block content %}
<div class="chat-section">
  <div class="chat-header">
    <div class="chat-header-avatar">{{ chat_title|first }}</div>
    <div class="chat-header-info">
      <h2>{{ chat_title }}</h2>
      <p>Last seen today at {% now "h:i A" %}</p>
    </div>
    <div class="chat-header-actions">
      <span class="icon"><i class="fas fa-phone-alt"></i></span>
      <span class="icon"><i class="fas fa-video"></i></span>
      <span class="icon"><i class="fas fa-ellipsis-v"></i></span>
    </div>
  </div>
  <div class="chat-messages" id="messagesContainer">
    {% for message in messages %}
    <div class="message {% if message.sender_id.id == request.user.id %}sent{% else %}received{% endif %}">
      {% if message.sender_id.id != request.user.id %}
      <div class="message-avatar">{{ message.sender_id.first_name|first }}</div>
      {% endif %}
      <div class="message-content">
        <div class="message-bubble">{{ message.text }}</div>
        <div class="message-time" data-timestamp="{{ message.created_at|date:'U' }}">
          {{ message.created_at|date:"h:i A" }}
        </div>
      </div>
      <!-- Add emoji reaction icon for received messages -->
      {% if message.sender_id.id != request.user.id %}
      <div class="message-reaction">
        <span class="reaction-icon"><i class="far fa-smile"></i></span>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  <div class="chat-input">
    <span class="icon sticker-icon"><i class="far fa-smile"></i></span>
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <input type="hidden" id="chatId" value="{{ chat_id }}" />
    <span class="icon mic-icon" id="micIcon"><i class="fas fa-microphone"></i></span>
    <span class="icon plus-icon" id="plusIcon"><i class="fas fa-plus"></i></span>
    <span class="icon send-icon hidden" id="sendIcon"><i class="fas fa-paper-plane"></i></span>
  </div>
</div>

<style>
  /* Icon transitions */
  .chat-input .icon {
    transition: all 0.3s ease;
  }
  
  .chat-input .icon.hidden {
    display: none;
    opacity: 0;
    transform: scale(0.8);
  }
  
  .chat-input .icon:not(.hidden) {
    display: flex;
    opacity: 1;
    transform: scale(1);
  }

  /*.message-reaction {
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    align-self: center;
  }*/

  .message-reaction {
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    position: relative;
    top: -5px; /* Slightly shifts the icon up */
    display: flex;
    align-items: center; /* Centers vertically */
    height: 100%; /* Takes full height of message container */
  }

  .message:hover .message-reaction {
    opacity: 1;
    visibility: visible;
  }

  .reaction-icon {
    color: var(--text-light);
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease;
  }

  .reaction-icon:hover {
    color: var(--primary-color);
    transform: scale(1.2);
  }
</style>

<script>
  // DOM Elements
  const messageInput = document.getElementById('messageInput');
  const sendIcon = document.getElementById('sendIcon');
  const micIcon = document.getElementById('micIcon');
  const plusIcon = document.getElementById('plusIcon');
  const chatId = document.getElementById('chatId').value;
  const messagesContainer = document.getElementById('messagesContainer');

  // Function to check if a string contains only emoji
  function isOnlyEmoji(str) {
    const trimmed = str.trim();
    if (!trimmed) return false;
    
    // Regular expression that matches emoji characters
    const emojiRegex = /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\p{Emoji_Modifier_Base}\p{Emoji_Modifier}?)+$/u;
    return emojiRegex.test(trimmed);
  }

  // Function to toggle icons based on input
  function toggleIcons() {
    const inputText = messageInput.value;
    const hasContent = inputText.trim().length > 0 || isOnlyEmoji(inputText);
    
    if (hasContent) {
      micIcon.classList.add('hidden');
      plusIcon.classList.add('hidden');
      sendIcon.classList.remove('hidden');
    } else {
      micIcon.classList.remove('hidden');
      plusIcon.classList.remove('hidden');
      sendIcon.classList.add('hidden');
    }
  }

  // Convert UTC timestamps to Indian time
  function convertToIndianTime(timestamp) {
    const date = new Date(timestamp * 1000);
    const options = {
      timeZone: 'Asia/Kolkata',
      hour12: true,
      hour: 'numeric',
      minute: 'numeric'
    };
    return date.toLocaleTimeString('en-IN', options);
  }

  // Update all message timestamps to Indian time on page load
  document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.message-time[data-timestamp]');
    timeElements.forEach(el => {
      const timestamp = parseInt(el.getAttribute('data-timestamp'));
      el.textContent = convertToIndianTime(timestamp);
    });
  });

  // Function to get current Indian time
  function getCurrentIndianTime() {
    const options = {
      timeZone: 'Asia/Kolkata',
      hour12: true,
      hour: 'numeric',
      minute: 'numeric'
    };
    return new Date().toLocaleTimeString('en-IN', options);
  }

  // Initial call to set correct icon state
  toggleIcons();

  // Add event listeners for input changes
  messageInput.addEventListener('input', toggleIcons);

  function sendMessage() {
    const messageText = messageInput.value.trim();
    if (!messageText) return;

    fetch("/message/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: `chat_id=${chatId}&message_text=${encodeURIComponent(messageText)}`,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message sent";
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">${data.data.text}</div>
              <div class="message-time">${getCurrentIndianTime()}</div>
            </div>
          `;
          messagesContainer.appendChild(messageDiv);
          messageInput.value = "";
          toggleIcons();
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      })
      .catch((error) => console.error("Error:", error));
  }

  // Send message on Enter key or send icon click
  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

  sendIcon.addEventListener("click", sendMessage);

  // Auto-scroll to bottom of messages
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>

{% endblock %}