{% extends "enduser/Chats/chat.html" %} {% block title %}Message{% endblock %}
{% block content %}
<div class="chat-section">
  <div class="chat-header">
    <div class="chat-header-avatar">{{ chat_title|first }}</div>
    <div class="chat-header-info">
      <h2>{{ chat_title }}</h2>
      <p>Last seen today at {% now "h:i A" %}</p>
    </div>
    <div class="chat-header-actions">
      <span class="icon"><i class="fas fa-phone-alt"></i></span>
      <span class="icon"><i class="fas fa-video"></i></span>
      <span class="icon"><i class="fas fa-ellipsis-v"></i></span>
    </div>
  </div>
  <div class="chat-messages" id="messagesContainer">
    {% for message in messages %}
    <div class="message {% if message.sender_id.id == request.user.id %}sent{% else %}received{% endif %}">
      {% if message.sender_id.id != request.user.id %}
      <div class="message-avatar">{{ message.sender_id.first_name|first }}</div>
      {% endif %}
      <div class="message-content">
        <div class="message-bubble">{{ message.text }}</div>
        <div class="message-time" data-timestamp="{{ message.created_at|date:'U' }}">
          {{ message.created_at|date:"h:i A" }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="chat-input">
    <span class="icon sticker-icon" id="emojiPickerIcon"><i class="far fa-smile"></i></span>
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <input type="hidden" id="chatId" value="{{ chat_id }}" />
    <span class="icon mic-icon" id="micIcon"><i class="fas fa-microphone"></i></span>
    <span class="icon plus-icon" id="plusIcon"><i class="fas fa-plus"></i></span>
    <span class="icon send-icon hidden" id="sendIcon"><i class="fas fa-paper-plane"></i></span>
    
    <!-- Emoji Picker Container -->
    <div id="emojiPickerContainer" class="emoji-picker-container hidden">
      <div class="emoji-picker">
        <div class="emoji-categories">
          <button class="emoji-category-btn active" data-category="smileys">üòÄ</button>
          <button class="emoji-category-btn" data-category="animals">üêª</button>
          <button class="emoji-category-btn" data-category="food">üçé</button>
          <button class="emoji-category-btn" data-category="travel">‚úàÔ∏è</button>
          <button class="emoji-category-btn" data-category="objects">üí°</button>
        </div>
        <div class="emoji-grid" id="emojiGrid"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Icon transitions */
  .chat-input .icon {
    transition: all 0.3s ease;
  }
  
  .chat-input .icon.hidden {
    display: none;
    opacity: 0;
    transform: scale(0.8);
  }
  
  .chat-input .icon:not(.hidden) {
    display: flex;
    opacity: 1;
    transform: scale(1);
  }

  /* Emoji Picker Styles */
  .emoji-picker-container {
    position: absolute;
    bottom: 70px;
    left: 20px;
    z-index: 1000;
    background: linear-gradient(to bottom, #1a1a2e, #16213e);
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    width: 300px;
    height: 350px;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .emoji-picker {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .emoji-categories {
    display: flex;
    padding: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: linear-gradient(to right, #1a1a2e, #16213e);
  }

  .emoji-category-btn {
    background: none;
    border: none;
    font-size: 20px;
    padding: 5px 10px;
    cursor: pointer;
    color: var(--text-light);
    transition: all 0.3s ease;
  }

  .emoji-category-btn.active {
    color: var(--primary-color);
    transform: scale(1.2);
  }

  .emoji-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 5px;
    padding: 10px;
    overflow-y: auto;
  }

  .emoji-item {
    font-size: 24px;
    cursor: pointer;
    text-align: center;
    padding: 5px;
    border-radius: 5px;
    transition: all 0.2s ease;
  }

  .emoji-item:hover {
    background: rgba(108, 92, 231, 0.2);
    transform: scale(1.2);
  }

  .hidden {
    display: none;
  }
</style>

<script>
  // Emoji data
  const emojiData = {
    smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥'],
    animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ'],
    food: ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂', 'üåΩ', 'ü•ï', 'üßÑ', 'üßÖ', 'ü•î'],
    travel: ['‚úàÔ∏è', 'üöÄ', 'üöÅ', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ'],
    objects: ['‚åöÔ∏è', 'üì±', 'üíª', '‚å®Ô∏è', 'üñ•', 'üñ®', 'üñ±', 'üñ≤', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩ', 'üéû', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéô', 'üéö']
  };

  // DOM Elements
  const emojiPickerIcon = document.getElementById('emojiPickerIcon');
  const emojiPickerContainer = document.getElementById('emojiPickerContainer');
  const emojiGrid = document.getElementById('emojiGrid');
  const messageInput = document.getElementById('messageInput');
  const sendIcon = document.getElementById('sendIcon');
  const micIcon = document.getElementById('micIcon');
  const plusIcon = document.getElementById('plusIcon');
  const chatId = document.getElementById('chatId').value;
  const messagesContainer = document.getElementById('messagesContainer');

  // Function to check if a string contains only emoji
  function isOnlyEmoji(str) {
    const trimmed = str.trim();
    if (!trimmed) return false;
    
    // Regular expression that matches emoji characters
    const emojiRegex = /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\p{Emoji_Modifier_Base}\p{Emoji_Modifier}?)+$/u;
    return emojiRegex.test(trimmed);
  }

  // Function to toggle icons based on input
  function toggleIcons() {
    const inputText = messageInput.value;
    const hasContent = inputText.trim().length > 0 || isOnlyEmoji(inputText);
    
    if (hasContent) {
      micIcon.classList.add('hidden');
      plusIcon.classList.add('hidden');
      sendIcon.classList.remove('hidden');
    } else {
      micIcon.classList.remove('hidden');
      plusIcon.classList.remove('hidden');
      sendIcon.classList.add('hidden');
    }
  }

  // Convert UTC timestamps to Indian time
  function convertToIndianTime(timestamp) {
    const date = new Date(timestamp * 1000);
    const options = {
      timeZone: 'Asia/Kolkata',
      hour12: true,
      hour: 'numeric',
      minute: 'numeric'
    };
    return date.toLocaleTimeString('en-IN', options);
  }

  // Update all message timestamps to Indian time on page load
  document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.message-time[data-timestamp]');
    timeElements.forEach(el => {
      const timestamp = parseInt(el.getAttribute('data-timestamp'));
      el.textContent = convertToIndianTime(timestamp);
    });
  });

  // Emoji Picker Functionality
  emojiPickerIcon.addEventListener('click', (e) => {
    e.stopPropagation();
    emojiPickerContainer.classList.toggle('hidden');
    loadEmojis('smileys');
  });

  // Close emoji picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!emojiPickerContainer.contains(e.target) && e.target !== emojiPickerIcon) {
      emojiPickerContainer.classList.add('hidden');
    }
  });

  // Load emojis for a category
  function loadEmojis(category) {
    emojiGrid.innerHTML = '';
    emojiData[category].forEach(emoji => {
      const emojiElement = document.createElement('div');
      emojiElement.className = 'emoji-item';
      emojiElement.textContent = emoji;
      emojiElement.addEventListener('click', () => {
        messageInput.value += emoji;
        messageInput.focus();
        toggleIcons(); // Update icons after adding emoji
      });
      emojiGrid.appendChild(emojiElement);
    });
  }

  // Category switching
  document.querySelectorAll('.emoji-category-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.emoji-category-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      loadEmojis(e.target.dataset.category);
    });
  });

  // Function to get current Indian time
  function getCurrentIndianTime() {
    const options = {
      timeZone: 'Asia/Kolkata',
      hour12: true,
      hour: 'numeric',
      minute: 'numeric'
    };
    return new Date().toLocaleTimeString('en-IN', options);
  }

  // Initial call to set correct icon state
  toggleIcons();

  // Add event listeners for input changes
  messageInput.addEventListener('input', toggleIcons);

  function sendMessage() {
    const messageText = messageInput.value.trim();
    if (!messageText) return;

    fetch("/message/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: `chat_id=${chatId}&message_text=${encodeURIComponent(messageText)}`,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message sent";
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">${data.data.text}</div>
              <div class="message-time">${getCurrentIndianTime()}</div>
            </div>
          `;
          messagesContainer.appendChild(messageDiv);
          messageInput.value = "";
          toggleIcons();
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      })
      .catch((error) => console.error("Error:", error));
  }

  // Send message on Enter key or send icon click
  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

  sendIcon.addEventListener("click", sendMessage);

  // Auto-scroll to bottom of messages
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>

{% endblock %}