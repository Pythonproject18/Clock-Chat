{% extends "adminuser/base.html" %}
{% load static %}

{% block title %}Clock-Chat Admin Dashboard{% endblock %}

{% block content %}
<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        background: linear-gradient(135deg, #f0f0f0, #dbeeff);
    }

    .content-wrapper {
        margin-left: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 90px;
        height: 95vh;
        width: 72vw;
    }

    .chart-container {
        flex: 1 1 40%;
        min-width: 300px;
        min-height: 500px;
        max-height: 90vh;
        border: 2px solid #ddd;
        padding: 20px;
        background-color: white;
        box-shadow: 3px 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    canvas {
        padding:10px;
        width: 100% !important;
        height: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
    }

    @media (max-width: 768px) {
        .chart-container {
            flex-basis: 100%;
            height: 400px;
        }
    }
</style>


<div class="content-wrapper">
  <div class="chart-container">
    <canvas id="lineChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="barChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- add Zoom plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>


<script>
// ─── User Line Chart ─────────────────────────────────────────────────────

const labels = {{ user_chart.labels|safe }};
const rawData = {{ user_chart.data|safe }};

// compute headroom
const highest = Math.max(...rawData);
const yPadding = 1;

const ctxLine = document.getElementById('lineChart').getContext('2d');
const gradient = ctxLine.createLinearGradient(0,0,0,ctxLine.canvas.height);
gradient.addColorStop(0, 'rgba(58,142,219,0.4)');
gradient.addColorStop(1, 'rgba(58,142,219,0)');

// crosshair plugin
const crosshairPlugin = {
  id: 'crosshairLine',
  afterDraw: chart => {
    const ctx = chart.ctx, tooltip = chart.tooltip;
    if (tooltip._active?.length) {
      const x = tooltip._active[0].element.x;
      const { top, bottom } = chart.chartArea;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(x, top);
      ctx.lineTo(x, bottom);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(58,142,219,0.3)';
      ctx.stroke();
      ctx.restore();
    }
  }
};
Chart.register(crosshairPlugin);

new Chart(ctxLine, {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'User Signups',
      data: rawData,
      fill: true,
      borderColor: '#3a8edb',
      backgroundColor: gradient,
      tension: 0.4,
      pointRadius: 4,
      pointHoverRadius: 6,
      pointBackgroundColor: '#3a8edb',
      pointBorderColor: '#ffffff',
      pointHoverBorderColor: '#1f5f9e',
      pointBorderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 1200, easing: 'easeInOutQuart' },
    scales: {
      x: {
        grid: { color: 'rgba(0,0,0,0.05)' },
        ticks: { font: { family: "'Segoe UI', sans-serif", size: 12 } }
      },
      y: {
        beginAtZero: true,
        max: highest + yPadding,
        ticks: { stepSize: 1, font: { family: "'Segoe UI', sans-serif", size: 12 } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    },
    interaction: { mode: 'index', intersect: false },
    plugins: {
      title: {
        display: true,
        text: 'Monthly User Report',
        font: { family: "'Segoe UI', sans-serif", size: 20 },
        color: '#333',
        padding: { bottom: 20 }
      },
      legend: { display: false },
      tooltip: {
        backgroundColor: '#333',
        titleFont: { family: "'Segoe UI', sans-serif", size: 14 },
        bodyFont: { family: "'Segoe UI', sans-serif", size: 13 },
        padding: 10,
        callbacks: {
          label: ctx => `${ctx.parsed.y} users`
        }
      },
      zoom: {
        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
        pan: { enabled: true, mode: 'x', threshold: 5 }
      }
    }
  },
  plugins: [crosshairPlugin]
});

// ─── Chats Bar Chart ────────────────────────────────────────────────────

// pull labels & datasets correctly
const chatLabels = {{ chat_chart.labels|safe }};
const personalData = {{ chat_chart.datasets.0.data|safe }};
const groupData = {{ chat_chart.datasets.1.data|safe }};

new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: chatLabels,
      datasets: [
        {
          label: 'Personal',
          data: personalData,
          backgroundColor: '#66b3ff',
          // ensure a minimal visible bar on zero
          minBarLength: 5
        },
        {
          label: 'Group',
          data: groupData,
          backgroundColor: '#a8c8e8',
          minBarLength: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Chats: Personal vs Group',
          align: 'start',
          font: { family: "'Segoe UI', sans-serif", size: 20 },
          padding: { bottom: 20 }
        },
        legend: { position: 'top' },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: Math.max(...personalData.concat(groupData)) + 2,
          grid: {
            color: ctx => ctx.tick.value === 0 ? '#000' : 'rgba(0,0,0,0.05)',
            lineWidth: ctx => ctx.tick.value === 0 ? 2 : 1
          },
          ticks: { stepSize: 1 }
        },
        x: { grid: { display: false } }
      }
    }
  });
  
</script>
{% endblock %}
